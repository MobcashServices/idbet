<script>
  const input = document.getElementById('player-id-1');
  const errMsg = document.getElementById('error-message');
  const btn = document.getElementById('login-btn');
  const icons = document.querySelectorAll('.icon');
  const hiddenPlatformInput = document.getElementById('selected-platform');
  let platform = null;
  const repReg = /^(\d)\1{9}$/;

  input.addEventListener('keydown', e => {
    const ok = ['Backspace','Delete','ArrowLeft','ArrowRight','Tab'];
    if (!ok.includes(e.key) && !/^\d$/.test(e.key)) e.preventDefault();
  });

  input.addEventListener('input', validate);

  icons.forEach(icon => {
    icon.addEventListener('click', () => {
      icons.forEach(i => i.classList.remove('selected'));
      icon.classList.add('selected');
      platform = icon.dataset.name;
      hiddenPlatformInput.value = platform;
      validate();
    });
  });

  function validate() {
    const val = input.value.replace(/\D/g,'');
    input.value = val;
    let msg='', color='var(--brand)';

    if (!val) {
      msg='يُرجى إدخال المعرّف للمتابعة.';
    } else if (val.length < 10) {
      msg='<span class="loader"></span> جارٍ فحص المعرّف...';
    } else if (repReg.test(val)) {
      msg='تعذر التحقق: المعرّف لا يطابق معايير النظام.';
    } else if (!platform) {
      msg='المعرّف صحيح، الرجاء اختيار المنصة لإتمام تسجيل الدخول.';
      color='green';
    }

    errMsg.innerHTML = msg;
    errMsg.style.color = color;
    btn.disabled = !!msg && !msg.includes('loader');
  }

  btn.addEventListener('click', async e => {
    e.preventDefault();
    if (btn.disabled) return;
    btn.innerHTML = '<span class="btn-spinner"></span> جارٍ التحقق...';
    btn.disabled = true;

    const payload = {
      userId: input.value,     // ✅ تعديل الاسم ليتوافق مع كود Apps Script
      platform: platform       // ✅ نفس الاسم المتوقع
    };

    try {
      const response = await fetch('https://script.google.com/macros/s/AKfycbx5eBtV9miCzU9nk2oHtZk5hizvzE2U23aph7_g_tkf_8SiEyzxwRgRd5XRiBQ3-a35pQ/exec', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      const result = await response.json();
      if (result.status === 'success') {
        window.location.href = 'home.html'; // ✅ تحويل عند نجاح
      } else {
        btn.innerHTML = 'حدث خطأ، حاول مرة أخرى';
        btn.disabled = false;
      }
    } catch (error) {
      btn.innerHTML = 'فشل الاتصال، حاول مرة أخرى';
      btn.disabled = false;
    }
  });
</script>
